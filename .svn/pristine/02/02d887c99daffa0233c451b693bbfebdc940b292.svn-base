package com.kivi.framework.cache.configuration;

import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;

import com.fasterxml.jackson.annotation.JsonAutoDetect;
import com.fasterxml.jackson.annotation.PropertyAccessor;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.kivi.framework.cache.redis.serializer.FastJson2JsonRedisSerializer;
import com.kivi.framework.cache.redis.serializer.Fst2JsonRedisSerializer;
import com.kivi.framework.cache.redis.serializer.KtfStringRedisSerializer;

public class RedisSerializerKit {

	/**
	 * 设置序列化方法:Jackson
	 */
	public static void setJackson2JsonRedisSerializer(RedisTemplate<?, ?> template) {
		Jackson2JsonRedisSerializer<Object>	jackson2JsonRedisSerializer	= new Jackson2JsonRedisSerializer<>(
				Object.class);
		ObjectMapper						om							= new ObjectMapper();
		om.setVisibility(PropertyAccessor.ALL, JsonAutoDetect.Visibility.ANY);
		om.enableDefaultTyping(ObjectMapper.DefaultTyping.NON_FINAL);
		jackson2JsonRedisSerializer.setObjectMapper(om);

		KtfStringRedisSerializer keySerializer = new KtfStringRedisSerializer();

		// template.setKeySerializer(template.getKeySerializer());
		template.setKeySerializer(keySerializer);
		template.setValueSerializer(jackson2JsonRedisSerializer);

		template.setDefaultSerializer(jackson2JsonRedisSerializer);
		template.setHashKeySerializer(template.getKeySerializer());
		template.setHashValueSerializer(jackson2JsonRedisSerializer);
	}

	/**
	 * 设置序列化方法:FastJson
	 */

	public static void setFastJson2JsonRedisSerializer(RedisTemplate<?, ?> template) {
		FastJson2JsonRedisSerializer<Object>	fastJson2JsonRedisSerializer	= new FastJson2JsonRedisSerializer<>(
				Object.class);

		KtfStringRedisSerializer				keySerializer					= new KtfStringRedisSerializer();
		// template.setKeySerializer(template.getKeySerializer());
		template.setKeySerializer(keySerializer);
		template.setValueSerializer(fastJson2JsonRedisSerializer);

		template.setDefaultSerializer(fastJson2JsonRedisSerializer);
		template.setHashKeySerializer(template.getKeySerializer());
		template.setHashValueSerializer(fastJson2JsonRedisSerializer);
	}

	/**
	 * 设置序列化方法:Fst，不适用于使用DevTools自动重启开启的情况
	 */
	protected void setFst2JsonRedisSerializer(RedisTemplate<?, ?> template) {
		Fst2JsonRedisSerializer<Object>	fst2JsonRedisSerializer	= new Fst2JsonRedisSerializer<>(Object.class);

		KtfStringRedisSerializer		keySerializer			= new KtfStringRedisSerializer();
		// template.setKeySerializer(template.getKeySerializer());
		template.setKeySerializer(keySerializer);
		template.setValueSerializer(fst2JsonRedisSerializer);
		template.setDefaultSerializer(fst2JsonRedisSerializer);
		template.setHashKeySerializer(template.getKeySerializer());
		template.setHashValueSerializer(fst2JsonRedisSerializer);
	}
}
